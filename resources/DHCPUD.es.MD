# Resoluci√≥n de direcciones

## ARP

- Cuando un paquete es enviado a nivel de red, este va encapsulado en una trama del nivel de enlace. El emisor debe saber qu√© direcci√≥n poner en la trama para la correcta comunicaci√≥n, y esta casi siempre es la MAC, para eso se utiliza ARP.
- Los mensajes ARP no son paquetes IP, por lo que tienen un Ethertype diferente: **0x0800** en el caso de IP y **0x0806** en el caso de ARP.

## Caso local

- Cuando un equipo en la red local quiere hacer un ping, por ejemplo, primero se crea el paquete IP. Luego se hace una operaci√≥n AND bit a bit con la m√°scara de red para verificar si el dispositivo con esa IP est√° en la misma subred. Si es as√≠, se encapsula en una trama Ethernet. Para hacer esto, se necesita la direcci√≥n MAC, y aqu√≠ es donde entra ARP.
- Se construye una tabla en el host que hace la correspondencia de IPs a MACs (ARP Cache), que inicia vac√≠a. Se manda un ARP Request a una direcci√≥n de broadcast preguntando por el destinatario. Uno de los dispositivos en la red responder√° (el que tenga dicha IP). El dispositivo que responde guarda la IP y MAC de quien pregunt√≥ en su ARP Cache. Posteriormente, el dispositivo con esa IP responder√° con un ARP Reply de forma unicast, ya que ya conoce los datos del solicitante. Al recibir esto, el solicitante anotar√° en su ARP Cache la informaci√≥n de la m√°quina por la cual pregunt√≥.
- En algunos casos, otros dispositivos en la red tambi√©n pueden actualizar su ARP Cache al recibir el ARP Reply.

## Caso remoto

- Si al hacer la comparaci√≥n de la m√°scara con la direcci√≥n IP de destino se determina que no est√° en la red local, no se preguntar√° por la IP del dispositivo destino, sino por la del **default gateway**, que ser√° el router a quien se enviar√° el mensaje para que lo reenv√≠e.
- El router guardar√° en su ARP Cache la IP y MAC del solicitante y enviar√° un ARP Reply. El solicitante guardar√° en su ARP Cache la IP y MAC del router, y entonces enviar√° el ping a la direcci√≥n de destino a trav√©s del router. El router enviar√° el paquete a Internet y reenviar√° la respuesta al solicitante.
- En este proceso, el dispositivo que hizo el ping usar√° la IP del destino externo pero la direcci√≥n MAC del router, que est√° en su ARP Cache. La direcci√≥n MAC cambiar√° a medida que el paquete pasa por routers en redes intermedias.

- En el mensaje ARP se repite la informaci√≥n de la MAC de origen y de destino (aunque ya est√°n en la trama Ethernet), porque el modelo de capas dice que cada capa debe ser autosuficiente.

## Tabla ARP Cache

- La tabla ARP Cache elimina una entrada si no se usa en 15 a 20 minutos, dependiendo de la implementaci√≥n, lo que hace que sea necesario rellenarla de nuevo si hay una nueva comunicaci√≥n. Esta tabla se indexa por IPs, lo que significa que varias IPs pueden apuntar a la misma MAC, pero no puede haber una IP que apunte a m√°s de una MAC diferente.
- Si se recibe por ARP una nueva MAC para una IP existente, se sustituye inmediatamente la vieja MAC por la nueva.
- Es importante tener en cuenta que el tama√±o de la tabla ARP puede estar limitado por la configuraci√≥n del sistema operativo, lo que podr√≠a causar problemas en redes con muchos dispositivos.

## Resoluci√≥n inversa de direcciones

- La resoluci√≥n inversa de direcciones es lo opuesto a ARP (Address Resolution Protocol). ARP toma una direcci√≥n IP y devuelve la MAC asociada, mientras que RARP (Reverse Address Resolution Protocol) cumple el papel opuesto: conociendo la direcci√≥n MAC, se obtiene una direcci√≥n IP.
- RARP se apoya en un **servidor** que almacena las correspondencias MAC ‚Üí IP, y hay tres protocolos que ayudan en esto: **RARP**, **BOOTP** y **DHCP**.

## RARP

> üí° Protocolo obsoleto, por eso no se hablar√° mucho de √©l.

- El formato de mensaje es el mismo que ARP.
- Para consultar una IP, se hace un RARP Request en modo broadcast y se recibe un RARP Reply si el servidor encuentra la MAC en sus tablas, en modo unicast.
- Utiliza un Ethertype diferente a ARP para facilitar el filtrado y distinguir un ARP Request de un RARP.
- Problemas:
    - Solo devuelve IPs y no configura m√°scaras de red, lo que limita su utilidad.
    - No es enrutable, quedando confinado en una red local (igual que ARP).

## BOOTP

- Su nombre proviene de la necesidad de usar m√°quinas sin disco (diskless).
- BOOTP pide a un servidor toda la configuraci√≥n IP, incluidas m√°scaras de subred.
- Como es un protocolo IP, puede viajar a trav√©s de routers, por lo que el servidor no necesita estar en la red local.
- Un **agente** en la red local (generalmente el router) recibe la petici√≥n BOOTP Request en modo broadcast y la reenv√≠a de forma unicast al servidor BOOTP, que conoce la direcci√≥n del servidor.

### BOOTP sin modificar ARP Cache

- El cliente env√≠a un BOOTP Request broadcast a la direcci√≥n 255.255.255.255 con la IP de origen 0.0.0.0 (ya que no conoce su IP).
- El servidor responde en broadcast, ya que el cliente no tiene una entrada ARP para ser identificado.

### BOOTP puede modificar ARP Cache

- Si el kernel lo permite, BOOTP puede modificar la ARP Cache a√±adiendo la MAC y la IP del cliente, y puede enviar un BOOTP Reply unicast.

### BOOTP servidor remoto

- La LAN env√≠a la petici√≥n BOOTP en broadcast. El agente (router) reenv√≠a la petici√≥n de forma unicast al servidor remoto, y recibe la respuesta en unicast. Dependiendo del agente, la respuesta puede enviarse en broadcast o unicast.

## DHCP

- DHCP es similar a BOOTP pero con diferencias en la asignaci√≥n de IPs. En DHCP hay tres opciones:
    - **Configuraci√≥n est√°tica:** Igual que BOOTP, IP manual.
    - **Configuraci√≥n din√°mica:** Las IPs se alquilan por un periodo de tiempo y deben renovarse.
    - **Asignaci√≥n autom√°tica:** Una IP es asignada permanentemente a una MAC solicitante.
- Los paquetes DHCP y BOOTP son id√©nticos. Las respuestas pueden ser broadcast o unicast, y un servidor DHCP que usa direccionamiento manual es equivalente a uno BOOTP.
- Es com√∫n dejar un subconjunto de rango de IPs reservado para configuraciones manuales.

## Consideraciones de seguridad

- ARP es susceptible a ataques como **ARP spoofing**, en los que un atacante enga√±a a los dispositivos de la red para asociar su direcci√≥n MAC con la IP de otro dispositivo. Esto puede permitir ataques de tipo Man-in-the-Middle (MITM). Es importante implementar medidas de seguridad como la autenticaci√≥n de ARP o tablas ARP est√°ticas en redes sensibles.
